<% 
  // Set page title
  const title = 'Manage Books';
%>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
    <div>
        <h1 style="font-family: 'Playfair Display', serif; font-size: 42px; margin-bottom: 8px;">Manage Books</h1>
        <p style="color: #64748b; font-size: 18px;"><%= totalBooks %> total books in database</p>
    </div>
    <a href="/admin/books/add" class="btn btn-primary">+ Add New Book</a>
</div>

<!-- Flash Messages -->
<% if (successMessage) { %>
    <div class="alert alert-success">
        ✓ <%= successMessage %>
    </div>
<% } %>

<% if (errorMessage) { %>
    <div class="alert alert-error">
        ✗ <%= errorMessage %>
    </div>
<% } %>

<!-- Search and Table -->
<div class="table-container">
    <!-- Search Box -->
    <div class="search-box">
        <form action="/admin/books" method="GET" style="display: flex; gap: 12px; width: 100%;">
            <input 
                type="text" 
                name="q" 
                placeholder="Search books by title, author, or description..." 
                value="<%= searchQuery %>"
                style="flex: 1;">
            <button type="submit" class="btn btn-secondary">Search</button>
            <% if (searchQuery) { %>
                <a href="/admin/books" class="btn btn-secondary">Clear</a>
            <% } %>
        </form>
    </div>

    <!-- Books Table -->
    <table style="width: 100%;">
        <thead>
            <tr>
                <th style="padding: 16px; text-align: left; background: #f1f5f9; border-bottom: 2px solid #e2e8f0;">Title</th>
                <th style="padding: 16px; text-align: left; background: #f1f5f9; border-bottom: 2px solid #e2e8f0;">Author</th>
                <th style="padding: 16px; text-align: left; background: #f1f5f9; border-bottom: 2px solid #e2e8f0;">Genre</th>
                <th style="padding: 16px; text-align: left; background: #f1f5f9; border-bottom: 2px solid #e2e8f0;">Status</th>
                <th style="padding: 16px; text-align: left; background: #f1f5f9; border-bottom: 2px solid #e2e8f0;">Rating</th>
                <th style="padding: 16px; text-align: left; background: #f1f5f9; border-bottom: 2px solid #e2e8f0;">Actions</th>
            </tr>
        </thead>
        <tbody>
            <% if (books.length === 0) { %>
                <tr>
                    <td colspan="6" style="padding: 40px; text-align: center; color: #64748b;">
                        <% if (searchQuery) { %>
                            No books found matching "<%= searchQuery %>". <a href="/admin/books">Show all books</a>
                        <% } else { %>
                            No books in database. <a href="/admin/books/add">Add your first book</a>
                        <% } %>
                    </td>
                </tr>
            <% } else { %>
                <% books.forEach(book => { %>
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 16px;">
                            <strong style="color: #0f172a;"><%= book.title %></strong>
                            <% if (book.isbn) { %>
                                <br><small style="color: #64748b;">ISBN: <%= book.isbn %></small>
                            <% } %>
                        </td>
                        <td style="padding: 16px; color: #475569;"><%= book.author %></td>
                        <td style="padding: 16px;">
                            <span style="background: #fef3c7; color: #f59e0b; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                <%= book.genre || 'General' %>
                            </span>
                        </td>
                        <td style="padding: 16px;">
                            <% if (book.available) { %>
                                <span style="background: #d1fae5; color: #047857; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    Available
                                </span>
                            <% } else { %>
                                <span style="background: #fee2e2; color: #b91c1c; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    <%= book.status || 'Borrowed' %>
                                </span>
                            <% } %>
                        </td>
                        <td style="padding: 16px;">
                            <% if (book.rating) { %>
                                <%= book.rating.toFixed(1) %> ⭐
                            <% } else { %>
                                <span style="color: #94a3b8;">N/A</span>
                            <% } %>
                        </td>
                        <td style="padding: 16px;">
                            <div style="display: flex; gap: 8px;">
                                <a href="/admin/books/<%= book._id %>/edit" class="btn btn-secondary btn-sm">Edit</a>
                                <form action="/admin/books/<%= book._id %>/delete" method="POST" style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to delete this book?');">
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                <% }); %>
            <% } %>
        </tbody>
    </table>

    <!-- Pagination -->
    <% if (totalPages > 1) { %>
        <div class="pagination">
            <% if (currentPage > 1) { %>
                <a href="/admin/books?page=<%= currentPage - 1 %><%= searchQuery ? '&q=' + searchQuery : '' %>">← Previous</a>
            <% } %>
            
            <% for (let i = 1; i <= totalPages; i++) { %>
                <% if (i === currentPage) { %>
                    <span class="active"><%= i %></span>
                <% } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) { %>
                    <a href="/admin/books?page=<%= i %><%= searchQuery ? '&q=' + searchQuery : '' %>"><%= i %></a>
                <% } else if (i === currentPage - 3 || i === currentPage + 3) { %>
                    <span>...</span>
                <% } %>
            <% } %>
            
            <% if (currentPage < totalPages) { %>
                <a href="/admin/books?page=<%= currentPage + 1 %><%= searchQuery ? '&q=' + searchQuery : '' %>">Next →</a>
            <% } %>
        </div>
    <% } %>
</div>
